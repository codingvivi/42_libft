CC = cc
CFLAGS = -g -Werror -Wall -Wextra 

NAME = libft.a


UNITY_DIR = unity
SRC_DIR = .
BUILD_DIR = build
TEST_SRC_DIR = test
OBJ_DIR = $(BUILD_DIR)/obj
TEST_BUILD_DIR = $(BUILD_DIR)/test/obj
RUNNER_DIR = $(BUILD_DIR)/runners

ifeq ($(OSTYPE),cygwin)
	CLEANC=rm -f
	MKDIRC=mkdir -p
	TARGET_EXTENSION=.out
else ifeq ($(OS),Windows_NT)
	CLEANC=del /F /Q
	MKDIRC=mkdir
	TARGET_EXTENSION=.exe
else
	CLEANC=rm -f
	MKDIRC=mkdir -p
	TARGET_EXTENSION=.out
endif

RUNNER_GEN = unity/auto/generate_test_runner.rb


SRCS = \
	ft_isalpha.c \
	ft_isdigit.c \
	ft_isalnum.c \

SRCS_TO_ADD = \
	ft_isascii.c \
	ft_isprint.c \
	ft_strlen.c \
	ft_memset.c \
	ft_bzero.c \
	ft_memcpy.c \
	ft_memmove.c \
	ft_strrchr.c \
	ft_strncmp.c \
	ft_strlcpy.c \
	ft_strlcat.c \
	ft_memchr.c \
	ft_memcmp.c \
	ft_toupper.c \
	ft_tolower.c \
	ft_strnstr.c \
	ft_strchr.c \
	ft_atoi.c

OBJS = $(addprefix $(OBJ_DIR)/, $(SRCS:.c=.o))

.PHONY: all clean fclean re

all: $(NAME)

$(NAME): $(OBJS)
	ar rcs $(NAME) $(OBJS)
	@echo "created $(NAME)"

$(OBJ_DIR)/%.o: %.c | $(OBJ_DIR)
	$(CC) $(CFLAGS) -I. -c $< -o $@


.PHONY: test test-all

TEST_NAMES := $(patsubst %.c,test_%,$(SRCS))

TEST_BINS := $(addprefix $(TEST_BUILD_DIR)/, $(addsuffix $(TARGET_EXTENSION), $(addsuffix _Runner, $(TEST_NAMES))))

test: 
	@$(MAKE) test-all

test-all: $(TEST_BINS)
	@echo "Running all tests"
	@for test_bin in $(TEST_BINS); do \
		./$$test_bin; \
	done

# -I. since its in different folder
$(TEST_BUILD_DIR)/test_%_Runner$(TARGET_EXTENSION): $(RUNNER_DIR)/test_%_Runner.c $(NAME)
	$(CC) $(CFLAGS) -I./test -I$(UNITY_DIR)/src \
	 $< \
	 -L. -lft \
	 -o $@_Runner 

$(RUNNER_DIR)/test_%_Runner.c: $(TEST_SRC_DIR)/test_%.c | $(RUNNER_DIR)
	@echo "generating runner for"
	@ruby $(RUNNER_GEN) $< $@

# TEST_BINS := $()

# TEST_SRCS = $(patsubst %.c, test_%.c, $(SRCS))


# RUNNER_SRCS = $(patsubst %.c, %_Runner.c, $(TEST_SRCS))

# TEST_DIR = test
# TEST_OBJ = $(TEST_SRCS:.c=.o)


# $(RUNNER_SRCS): $(TEST_SRCS)
# 	@echo "--> Generating runner for"

$(BUILD_DIR) $(OBJ_DIR) $(RUNNER_DIR) $(TEST_BUILD_DIR) $(TEST_BUILD_DIR)/runners:
	$(MKDIRC) $@

# 	$(MKDIRC) $(OBJ_DIR)

# 	$(MKDIRC) $(RUNNER_DIR)


# $(OBJ_DIR)/%.o: $(SRC_DIR)/%.c $(OBJ_DIR)
# 	cc -c $(SRC)

# $(NAME): $(OBJ)
		

